package com.algolia.codegen;

import com.algolia.codegen.exceptions.*;
import com.algolia.codegen.utils.*;
import com.algolia.codegen.utils.OneOf;
import com.google.common.collect.Iterables;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.Operation;
import io.swagger.v3.oas.models.servers.Server;
import java.io.File;
import java.util.*;
import org.openapitools.codegen.*;
import org.openapitools.codegen.languages.GoClientCodegen;
import org.openapitools.codegen.model.ModelMap;
import org.openapitools.codegen.model.ModelsMap;
import org.openapitools.codegen.model.OperationsMap;

public class AlgoliaGoGenerator extends GoClientCodegen {

  @Override
  public String getName() {
    return "algolia-go";
  }

  @Override
  public void processOpts() {
    String client = (String) additionalProperties.get("client");

    additionalProperties.put("packageName", client.equals("query-suggestions") ? "suggestions" : client);
    additionalProperties.put("enumClassPrefix", true);
    additionalProperties.put("isSearchClient", client.equals("search"));

    String outputFolder = "algolia" + File.separator + client;
    setOutputDir(getOutputDir() + File.separator + outputFolder);

    super.processOpts();

    // Generation notice, added on every generated files
    // The banner is custom for go because golangci-lint will not format generated files, and we
    // can't disable it
    // https://github.com/golangci/golangci-lint/blob/f921f000f8494e32d2d5d38939c999414bb6b7e1/pkg/result/processors/autogenerated_exclude.go#L77
    additionalProperties.put(
      "generationBanner",
      "File generated by OpenAPI Generator (https://openapi-generator.tech), manual changes will" +
      " be lost - read more on https://github.com/algolia/api-clients-automation."
    );

    apiTestTemplateFiles.clear();
    modelTestTemplateFiles.clear();
    apiDocTemplateFiles.clear();
    modelDocTemplateFiles.clear();

    supportingFiles.clear();
    supportingFiles.add(new SupportingFile("configuration.mustache", "", "configuration.go"));
    supportingFiles.add(new SupportingFile("client.mustache", "", "client.go"));

    try {
      additionalProperties.put("packageVersion", Helpers.getClientConfigField("go", "packageVersion"));
    } catch (GeneratorException e) {
      e.printStackTrace();
      System.exit(1);
    }
  }

  @Override
  public void processOpenAPI(OpenAPI openAPI) {
    super.processOpenAPI(openAPI);
    Helpers.generateServers(super.fromServers(openAPI.getServers()), additionalProperties);
  }

  @Override
  public CodegenOperation fromOperation(String path, String httpMethod, Operation operation, List<Server> servers) {
    return Helpers.specifyCustomRequest(super.fromOperation(path, httpMethod, operation, servers));
  }

  @Override
  public ModelsMap postProcessModels(ModelsMap objs) {
    objs = super.postProcessModels(objs);

    for (ModelMap modelMap : objs.getModels()) {
      CodegenModel model = modelMap.getModel();
      if (model.isEnum) {
        continue;
      }

      for (CodegenProperty param : Iterables.concat(model.vars, model.allVars, model.requiredVars, model.optionalVars)) {
        if (
          !param.isNullable || !param.isPrimitiveType || param.isContainer || param.isFreeFormObject || (param.isAnyType && !param.isModel)
        ) {
          continue;
        }

        param.dataType = "utils." + param.dataType;
      }
    }

    return objs;
  }

  @Override
  public Map<String, ModelsMap> postProcessAllModels(Map<String, ModelsMap> objs) {
    Map<String, ModelsMap> models = super.postProcessAllModels(objs);
    OneOf.updateModelsOneOf(models, modelPackage);
    GenericPropagator.propagateGenericsToModels(models);

    for (Map.Entry<String, ModelsMap> entry : models.entrySet()) {
      String modelName = entry.getKey();
      CodegenModel model = entry.getValue().getModels().get(0).getModel();

      // for some reason the property additionalPropertiesIsAnyType is not propagated to the
      // property
      for (CodegenProperty prop : model.getVars()) {
        ModelsMap propertyModel = models.get(prop.datatypeWithEnum);
        if (propertyModel != null && propertyModel.getModels().get(0).getModel().getAdditionalPropertiesIsAnyType()) {
          // consider it the same as model for our purpose
          prop.isModel = true;
        }

        // simplify some dataTypes
        if (prop.dataType.contains("[]*[]")) {
          prop.dataType = prop.dataType.replace("[]*[]", "[][]");
          prop.vendorExtensions.put("x-go-base-type", prop.dataType);
        }
      }
    }
    return models;
  }

  @Override
  public OperationsMap postProcessOperationsWithModels(OperationsMap objs, List<ModelMap> models) {
    OperationsMap operations = super.postProcessOperationsWithModels(objs, models);
    Helpers.removeHelpers(operations);
    GenericPropagator.propagateGenericsToOperations(operations, models);
    return operations;
  }
}
