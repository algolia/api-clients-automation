name: Checks

on:
  pull_request:
    types: [opened, synchronize, closed]

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-20.04
    outputs:
      TESTS_CHANGED: ${{ steps.setup.outputs.TESTS_CHANGED }}
      SPECS_CHANGED: ${{ steps.setup.outputs.SPECS_CHANGED }}
      SCRIPTS_CHANGED: ${{ steps.setup.outputs.SCRIPTS_CHANGED }}
      JS_CLIENT_CHANGED: ${{ steps.setup.outputs.JS_CLIENT_CHANGED }}
      JS_TEMPLATE_CHANGED: ${{ steps.setup.outputs.JS_TEMPLATE_CHANGED }}
      JAVA_CLIENT_CHANGED: ${{ steps.setup.outputs.JAVA_CLIENT_CHANGED }}
      JAVA_TEMPLATE_CHANGED: ${{ steps.setup.outputs.JAVA_TEMPLATE_CHANGED }}
      RUN_SPECS: ${{ steps.setup.outputs.RUN_SPECS }}
      RUN_CTS: ${{ steps.setup.outputs.RUN_CTS }}
      RUN_JS_CLIENT: ${{ steps.setup.outputs.RUN_JS_CLIENT }}
      RUN_JAVA_CLIENT: ${{ steps.setup.outputs.RUN_JAVA_CLIENT }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Setup
        id: setup
        uses: ./.github/actions/setup

  check:
    runs-on: ubuntu-20.04
    needs: setup
    steps:
      - uses: actions/checkout@v2

      - name: Checking
        run: |
          echo ${{ needs.setup.outputs }}
          echo ${{ toJSON(needs.setup.outputs) }}

  specs:
    runs-on: ubuntu-20.04
    needs: setup
    if: ${{ always() && needs.setup.outputs.RUN_SPECS }}
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache

      - name: Checking search specs
        run: yarn build:specs search

      - name: Checking recommend specs
        run: yarn build:specs recommend

      - name: Checking personalization specs
        run: yarn build:specs personalization

      - name: Checking analytics specs
        run: yarn build:specs analytics

      - name: Lint
        run: yarn specs:lint

  client_javascript:
    runs-on: ubuntu-20.04
    needs: [setup, specs]
    if: ${{ always() && needs.setup.outputs.RUN_JS_CLIENT }}
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache

      - name: Generate search client
        run: yarn generate javascript search

      - name: Build search client
        run: yarn build:clients javascript search

      - name: Generate recommend client
        run: yarn generate javascript recommend

      - name: Build recommend client
        run: yarn build:clients javascript recommend

      - name: Generate personalization client
        run: yarn generate javascript personalization

      - name: Build personalization client
        run: yarn build:clients javascript personalization

      - name: Generate analytics client
        run: yarn generate javascript analytics

      - name: Build analytics client
        run: yarn build:clients javascript analytics

      - name: Lint
        run: yarn lint

  client_java:
    runs-on: ubuntu-20.04
    needs: [setup, specs]
    if: ${{ always() && needs.setup.outputs.RUN_JAVA_CLIENT }}
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache

      - name: Generate search client
        run: yarn generate java search

      - name: Build search client
        run: yarn build:clients java search

  cts:
    runs-on: ubuntu-20.04
    needs: [setup, specs, client_javascript, client_java]
    if: ${{ always() && needs.setup.outputs.RUN_CTS }}
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache

      - name: Generate clients
        run: yarn generate

      - name: Build client
        run: yarn build:clients

      - name: Generate CTS
        run: yarn cts:generate

      - name: Run CTS
        run: yarn cts:test
