name: Checks

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
      - main

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Setup
        id: setup
        uses: ./.github/actions/setup

      - name: Lint GitHub actions
        run: yarn eslint --ext=yml .github/actions .github/workflows

    outputs:
      RUN_SPECS_SEARCH: ${{ steps.setup.outputs.RUN_SPECS_SEARCH }}
      RUN_SPECS_RECOMMEND: ${{ steps.setup.outputs.RUN_SPECS_RECOMMEND }}
      RUN_SPECS_QS: ${{ steps.setup.outputs.RUN_SPECS_QS }}
      RUN_SPECS_PERSO: ${{ steps.setup.outputs.RUN_SPECS_PERSO }}
      RUN_SPECS_INSIGHTS: ${{ steps.setup.outputs.RUN_SPECS_INSIGHTS }}
      RUN_SPECS_ANALYTICS: ${{ steps.setup.outputs.RUN_SPECS_ANALYTICS }}
      RUN_SPECS_AB: ${{ steps.setup.outputs.RUN_SPECS_AB }}

      RUN_JS_CLIENT_SEARCH: ${{ steps.setup.outputs.RUN_JS_CLIENT_SEARCH }}
      RUN_JS_CLIENT_RECOMMEND: ${{ steps.setup.outputs.RUN_JS_CLIENT_RECOMMEND }}
      RUN_JS_CLIENT_PERSO: ${{ steps.setup.outputs.RUN_JS_CLIENT_PERSO }}
      RUN_JS_CLIENT_ANALYTICS: ${{ steps.setup.outputs.RUN_JS_CLIENT_ANALYTICS }}
      RUN_JS_CLIENT_INSIGHTS: ${{ steps.setup.outputs.RUN_JS_CLIENT_INSIGHTS }}

      RUN_JAVA_CLIENT: ${{ steps.setup.outputs.RUN_JAVA_CLIENT }}

      RUN_CTS: ${{ steps.setup.outputs.RUN_CTS }}
      SPECS_MATRIX: ${{ steps.setup.outputs.SPECS_MATRIX }}

  specs:
    runs-on: ubuntu-20.04
    needs: setup
    strategy:
      matrix: ${{ fromJSON(needs.setup.outputs.SPECS_MATRIX)}}
    steps:
      - uses: actions/checkout@v2

      - name: Restore cache
        uses: ./.github/actions/cache

      - name: Checking ${{ matrix.client }} specs
        run: yarn build:specs ${{ matrix.client }}

      - name: Lint ${{ matrix.client }} specs
        run: yarn eslint --ext=yml specs/${{ matrix.client }}
