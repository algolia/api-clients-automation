// Code generated by OpenAPI Generator (https://openapi-generator.tech), manual changes will be lost - read more on https://github.com/algolia/api-clients-automation. DO NOT EDIT.
package e2e

import (
	"encoding/json"
	"gotests/tests"
	"os"
	"testing"

	"github.com/kinbiko/jsonassert"
	"github.com/stretchr/testify/require"

	"github.com/joho/godotenv"

	"github.com/algolia/algoliasearch-client-go/v4/algolia/composition"
)

func createE2ECompositionClient(t *testing.T) *composition.APIClient {
	t.Helper()

	appID := os.Getenv("METIS_APPLICATION_ID")
	if appID == "" && os.Getenv("CI") != "true" {
		err := godotenv.Load("../../../../.env")
		require.NoError(t, err)
		appID = os.Getenv("METIS_APPLICATION_ID")
	}
	apiKey := os.Getenv("METIS_API_KEY")
	client, err := composition.NewClient(appID, apiKey)
	require.NoError(t, err)

	return client
}

func TestCompositionE2E_ListCompositions(t *testing.T) {
	t.Run("listCompositions", func(t *testing.T) {
		client := createE2ECompositionClient(t)
		res, err := client.ListCompositions(client.NewApiListCompositionsRequest())
		require.NoError(t, err)
		_ = res

		rawBody, err := json.Marshal(res)
		require.NoError(t, err)

		var rawBodyMap any
		err = json.Unmarshal(rawBody, &rawBodyMap)
		require.NoError(t, err)

		expectedBodyRaw := `{"items":[{"objectID":"id1","name":"my first composition","description":"the first ever composition from the client","behavior":{"injection":{"main":{"source":{"search":{"index":"cts_e2e_small"}}}}}}],"nbPages":1}`
		var expectedBody any
		err = json.Unmarshal([]byte(expectedBodyRaw), &expectedBody)
		require.NoError(t, err)

		unionBody := tests.Union(t, expectedBody, rawBodyMap)
		unionBodyRaw, err := json.Marshal(unionBody)
		require.NoError(t, err)

		jsonassert.New(t).Assertf(string(unionBodyRaw), expectedBodyRaw)
	})
}
