post:
  tags:
    - predict
  operationId: fetchUserProfile
  description: |
    Get predictions, properties (raw, computed or custom) and segments (computed or custom) for an authenticated user (userID) or an anonymous user (cookieID).

    The predictions can be goals, metrics or affinities: 
    * **Goals** ML models compute the probability for an action. Ex. A funnel stage model can output the next stage in the user conversion funnel - add_to_cart with a probability of 72%.
    * **Metrics** ML models output a number. Ex. Next order value is 172.43 USD. Since metrics models are usually based on regression, these predictions have a single value without a probability attached to it.
    * **Affinities** ML models output a set of item attributes with associated probabilities. Ex. a user is interested in items with the following characteristics: *color: red* (56% probability), *brand: Adidas* (67% probability).

    The usage of segments for a user profile assumes that actions are implemented in a website or app and can be triggered when a segment is identified: *if segment1 in user_segments then do action*. For example, a segment can represent users that are close to churning and the action can be offering them an incentive such as a discount code or free shipping.

  summary: Get user profile
  parameters:
    - $ref: '../common/parameters.yml#/userID'

  requestBody:
    required: true
    content:
      application/json:
        schema:
          additionalProperties: false
          properties:
            modelsToRetrieve:
              description: List with model types for which to retrieve predictions
              type: array
              items:
                type: string
                enum:
                  - funnel_stage
                  - order_value
                  - affinities
              minItems: 1
            typesToRetrieve:
              description: List with types to be retrieved.
              type: array
              items:
                type: string
                enum:
                  - properties
                  - segments
              minItems: 1

  responses:
    '200':
      description: OK
      content:
        application/json:
          schema:
            title: fetchUserProfileResponse
            type: object
            required:
              - user
            properties:
              user:
                type: string
              predictions:
                type: object
                properties:
                  funnel_stage:
                    type: object
                    description: Prediction for the **funnel_stage** model
                    properties:
                      value:
                        type: array
                        items:
                          type: object
                          properties:
                            name:
                              type: string
                              enum:
                                - all_visits
                                - click_product_list
                                - product_view
                                - add_to_cart
                                - checkout
                                - transaction
                            probability:
                              type: number
                              minimum: 0
                              maximum: 1
                      lastUpdatedAt:
                        type: string
                  order_value:
                    type: object
                    description: Prediction for the **order_value** model
                    properties:
                      value:
                        type: number
                        minimum: 0
                      lastUpdatedAt:
                        type: string
                  affinities:
                    type: object
                    description: Prediction for the **affinities** model
                    properties:
                      value:
                        type: array
                        items:
                          type: object
                          properties:
                            name:
                              type: string
                            value:
                              type: string
                            probability:
                              type: number
                              minimum: 0
                              maximum: 1
                      lastUpdatedAt:
                        type: string
              properties:
                type: object
                description: Properties for the user profile
                properties:
                  raw:
                    type: object
                    description: Raw user properties (key-value pairs)
                  computed:
                    type: object
                    description: Computed user properties (key-value pairs)
                  custom:
                    type: object
                    description: Custom user properties (key-value pairs)
              segments:
                type: object
                description: Segments that the user belongs to
                properties:
                  computed:
                    type: array
                    description: List of computed segments IDs
                    items:
                      type: string
                  custom:
                    type: array
                    description: List of custom segments IDs
                    items:
                      type: string
    '404':
      $ref: ../responses/UserNotFound.yml
    '405':
      $ref: ../../common/responses/MethodNotAllowed.yml
